$(document).ready(function(){"use strict";$.ReportDirector={Init:function(){this.InitActions(),this.InitTemplate(),this.InitDynamicData()},InitActions:function(){function t(t,e,a){var r=e;switch(a||"number"){case"number":e=e>0?e:"";break;case"decimal":e=e>0?e:""}if(null!=$(t).contentEditable)$(t).attr("contentEditable",isEdit);else{var l=$("<input/>",{type:"text",min:0,value:e}).attr("last-value",r);switch(a||"number"){case"number":l.numeric();break;case"decimal":l.numeric(),l.keydown(function(t){if("188"==t.keyCode||"188"==t.charCode||"110"==t.keyCode||"110"==t.charCode){t.preventDefault();var e=$(t.target),a=e.val().indexOf(".");if(a>0)return;e.val(e.val()+".")}})}$(t).html(l),l.focus()}}$(document).on("click","#ReportOverallSalary_data a.confirm",function(){function t(t){t.status?(e.html("подтверждено"),alert("Данные успешно отправлены в общую таблицу з/п")):alert("Ошибка: "+t.message)}var e=$(this).closest("td"),a={SiteID:$("#overlaySalarySite").find("input:radio:checked").val(),employee:$(this).closest("tr").attr("id-employee"),year:$("#overlay-salary-year").data("DateTimePicker").date().year(),month:$("#overlay-salary-month").val()};$.post(BaseUrl+"reports/overlay/salary/close",a,t,"json")}),$(document).on("click","#overlaySalarySite input:radio",function(t){$.ReportDirector.ReloadReportOverallSalary($(t.target).val())}),$(document).on("click","#ReportOverallSalary_data>tbody>tr>td[type]>div",function(){var e=$(this).parent().hasClass("decimal")?"decimal":"number";t($(this).parent(),$(this).html(),e)}),$(document).on("focusout","#ReportOverallSalary_data td[type]>input",function(){function t(t){a.html($("<div/>",{text:t}))}function e(e){if(e.status){t(o);var r=a.attr("original")||0;o!=r?a.addClass("editable-cell"):a.removeClass("editable-cell");var i=a.closest("tr").find(".status");"подтверждено"==i.html()&&i.html('<a href="#" class="confirm">подтвердить</a>'),$.ReportDirector.RefreshReportOverallSalaryDataSummary()}else t(l),alert("Ошибка: "+e.message)}var a=$(this).parent(),r=a.hasClass("decimal"),l=r?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),o=r?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(l!=o){var i=$("#overlay-salary-year").data("DateTimePicker").date().year(),s=$("#overlay-salary-month").val(),n=a.attr("type"),d={SiteID:$("#overlaySalarySite").find("input:radio:checked").val(),idEmployee:a.closest("tr").attr("id-employee"),year:i,month:s,type:n,value:o};$.post(BaseUrl+"reports/overlay/salary/save",d,e,"json")}else t(l)}),$(document).on("click","#ReportGeneralSalary_data thead td[id-site]>div",function(){t($(this).parent(),$(this).html())}),$(document).on("focusout","#ReportGeneralSalary_data thead td[id-site]>input",function(){function t(t){a.html($("<div/>",{text:t}))}function e(e){e.status?(t(o),$.ReportDirector.ReloadReportGeneralSalaryDataSummary()):(t(l),alert("Ошибка: "+e.message))}var a=$(this).parent(),r=a.hasClass("decimal"),l=r?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),o=r?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(l!=o){var i=$("#general-salary-year").data("DateTimePicker").date().year(),s=$("#general-salary-month").val(),n={idEmployee:a.closest("tr").attr("id-employee"),idSite:a.attr("id-site"),year:i,month:s,value:o};$.post(BaseUrl+"reports/general/salary/save",n,e,"json")}else t(l)}),$(document).on("click","#ReportGeneralSalary_data .is-repay-tooltip .yes",function(){function t(t){t.status?e.addClass("repay"):alert("Ошибка: "+t.message)}var e=$(this).closest("td"),a={idRecord:e.find("div[id-record]").attr("id-record"),paid:1};$.post(BaseUrl+"reports/general/salary/paid",a,t,"json")}),$(document).on("click","#ReportGeneralSalary_data .is-repay-tooltip .no",function(){function t(t){t.status?e.removeClass("repay"):alert("Ошибка: "+t.message)}var e=$(this).closest("td"),a={idRecord:e.find("div[id-record]").attr("id-record"),paid:0};$.post(BaseUrl+"reports/general/salary/paid",a,t,"json")}),$(document).on("click","#overallAllocationSite input:radio",function(t){$.ReportDirector.ReloadReportOverallAllocation($(t.target).val())})},InitDynamicData:function(){},InitTemplate:function(){$("#reportGeneralOfCustomersTemplate").template("reportGeneralOfCustomersTemplate"),$("#reportGeneralOfCustomers_fixedWrapBody_Template").template("reportGeneralOfCustomers_fixedWrapBody_Template"),$("#reportGeneralOfCustomers_total_Template").template("reportGeneralOfCustomers_total_Template"),$("#reportOverallSalaryTemplate").template("reportOverallSalaryTemplate"),$("#reportGeneralSalarySumTemplate").template("reportGeneralSalarySumTemplate"),$("#reportOverallAllocation_Template").template("reportOverallAllocation_Template")},RefreshReportGeneralOfCustomersDate:function(t){function e(){return a.data("DateTimePicker").date().year()}var a=$("#general-customers-year"),r=$("#general-customers-month"),l=$("#general-customers-day"),o=moment([t||e(),r.val()]).endOf("month").date();l.empty(),l.append($("<option/>",{value:0,text:"за месяц"}));for(var i=1;i<=o;i++)l.append($("<option/>",{value:i,text:i}));r.val()==moment().month()&&l.find("[value='"+moment().date()+"']").attr("selected","selected"),$.ReportDirector.ReloadReportGeneralOfCustomersData()},RefreshReportGeneralOfCustomersDataSummary:function(){var t=$("#ReportGeneralOfCustomers_data"),e=$("#ReportGeneralOfCustomers_total"),a=$("#ReportGeneralOfCustomers_fixedWrapBody");$(t).find("tfoot td div").html(0),$(e).find("tbody td, tfoot td").html(0),$(a).find("tbody td, tfoot td").html(0),$(t).find("tbody .mail").each(function(){var t=$(this).attr("id-site"),e=$("#gc_foot_mail_"+t);e.html(parseFloat(e.html())+parseFloat($(this).find("div").html()));var a=$(this).attr("id-customer"),r=$("#gc_total_"+a).find("td:eq(0)");r.html(parseFloat(r.html())+parseFloat($(this).find("div").html()))}),$(t).find("tbody .chat").each(function(){var t=$(this).attr("id-site"),e=$("#gc_foot_chat_"+t);e.html(parseFloat(e.html())+parseFloat($(this).find("div").html()));var a=$(this).attr("id-customer"),r=$("#gc_total_"+a),l=r.find("td:eq(0)"),o=r.find("td:eq(1)"),i=r.find("td:eq(2)");o.html(parseFloat(o.html())+parseFloat($(this).find("div").html())),i.html(parseFloat(o.html())+parseFloat(l.html())),$("#gc_slide_total_"+a).find("td").html(i.html())});var r=$(e).find("tfoot>tr"),l=r.find("td:eq(0)"),o=r.find("td:eq(1)"),i=r.find("td:eq(2)");$(e).find("tbody>tr").each(function(){l.html(parseFloat(l.html())+parseFloat($(this).find("td:eq(0)").html())),o.html(parseFloat(o.html())+parseFloat($(this).find("td:eq(1)").html())),i.html(parseFloat(i.html())+parseFloat($(this).find("td:eq(2)").html()))}),$(a).find("tfoot>tr>td").html(i.html())},ReloadReportOverallSalary:function(t){function e(t){t.status?($.tmpl("reportOverallSalaryTemplate",t.records).appendTo(a),$.ReportDirector.RefreshReportOverallSalaryDataSummary()):alert("Ошибка получения данных")}t=t||$("#overlaySalarySite").find("input:radio:checked").val();var a=$("#ReportOverallSalary_data").find(">tbody");a.empty();var r={SiteID:t,year:$("#overlay-salary-year").data("DateTimePicker").date().year(),month:$("#overlay-salary-month").val()};$.post(BaseUrl+"reports/overlay/salary/data",r,e,"json")},RefreshReportOverallSalaryDataSummary:function(){var t=$("#ReportOverallSalary_data");$(t).find("tr").find("td:eq(9)").html(0),$(t).find("tbody>tr").each(function(){var t=parseFloat($(this).find("td:eq(2) div").html())||0,e=parseFloat($(this).find("td:eq(4) div").html())||0,a=parseFloat($(this).find("td:eq(6) div").html())||0,r=parseFloat($(this).find("td:eq(8) div").html())||0;$(this).find("td:eq(9)").html((t+e+a+r).toFixed(2))});var e=$(t).find("tfoot td:eq(9)");$(t).find("tbody>tr").find("td:eq(9)").each(function(){var t=parseFloat($(this).html())||0,a=parseFloat(e.html())||0;e.html((a+t).toFixed(2))})},ReloadReportGeneralSalary:function(){function t(t){t.status?($("#ReportGeneralSalary_data tbody tr[id-employee] td[id-site]").html("-"),$(t.cross).each(function(t,e){$('#ReportGeneralSalary_data tbody tr[id-employee="'+e.EmployeeID+'"] td[id-site="'+e.SiteID+'"]').html("")}),$(t.records).each(function(t,e){if(e.EmployeeID>0){var a='#ReportGeneralSalary_data tbody tr[id-employee="'+e.EmployeeID+'"] td[id-site="'+e.SiteID+'"]';1==e.paid&&$(a).closest("td").addClass("repay"),$.tmpl("reportGeneralSalarySumTemplate",e).appendTo(a)}else{var r='#ReportGeneralSalary_data thead tr[id-employee="'+e.EmployeeID+'"] td[id-site="'+e.SiteID+'"]';$(r).find("div").html(e.value)}}),$.ReportDirector.ReloadReportGeneralSalaryDataSummary()):alert("Ошибка получения данных")}$("#ReportGeneralSalary_data").find("thead tr[id-employee] td[id-site] div").empty(),$("#ReportGeneralSalary_data").find("tbody tr[id-employee] td[id-site]").empty().removeClass("repay");var e={year:$("#general-salary-year").data("DateTimePicker").date().year(),month:$("#general-salary-month").val()};$.post(BaseUrl+"reports/general/salary/data",e,t,"json")},ReloadReportGeneralSalaryDataSummary:function(){$(".total-salary-report-table thead td[id-site]").each(function(){var t=$(this).attr("id-site"),e=parseFloat($(this).find("div").html())||0;$('.total-salary-report-table tbody td[id-site="'+t+'"]').each(function(){e-=parseFloat($(this).find("div>a").html())||0}),$('.total-salary-report-table tfoot td[id-site="'+t+'"]').html(e.toFixed(2))})},ReloadReportGeneralOfCustomers:function(){$.ReportDirector.ReloadGeneralOfCustomersMeta()},ReloadReportOverallAllocation:function(t){function e(t){t.status?($.tmpl("reportOverallAllocation_Template",t.records).appendTo(a),$("#ReportOverallNotAllocation_data").find("td").html(t.records.freeAllSitesCustomers)):alert("Ошибка получения данных")}t=t||$("#overallAllocationSite").find("input:radio:checked").val();var a=$("#ReportOverallAllocation_data").find(">tbody");a.empty(),$("#ReportOverallNotAllocation_data").find("td").empty(),$.post(BaseUrl+"reports/overall/allocation/data",{SiteID:t},e,"json")},ReloadGeneralOfCustomersMeta:function(){function t(t){t.status&&($.tmpl("reportGeneralOfCustomersTemplate",t.records).appendTo("#ReportGeneralOfCustomers_data"),$.tmpl("reportGeneralOfCustomers_fixedWrapBody_Template",t.records.customers).appendTo("#ReportGeneralOfCustomers_fixedWrapBody>tbody"),$.tmpl("reportGeneralOfCustomers_total_Template",t.records.customers).appendTo("#ReportGeneralOfCustomers_total>tbody"),$.ReportDirector.RefreshReportGeneralOfCustomersDate())}$("#ReportGeneralOfCustomers_data").empty(),$("#ReportGeneralOfCustomers_fixedWrapBody").find(">tbody").empty(),$("#ReportGeneralOfCustomers_total").find(">tbody").empty(),$.getJSON(BaseUrl+"reports/general/customers/meta",t)},ReloadReportGeneralOfCustomersData:function(){function t(t){function e(t,e,a,r,l){t.addClass(e).attr("id-customer",a).attr("id-site",r).find("div").html(l||0)}$("#ReportGeneralOfCustomers_data").find(".mail div, .chat div").html(0),$.each(t.records,function(t,a){var r=a.CustomerID+"_"+a.SiteID;e($("#gc_mail_"+r),"mail",a.CustomerID,a.SiteID,a.emails),e($("#gc_chat_"+r),"chat",a.CustomerID,a.SiteID,a.chat)}),$.ReportDirector.RefreshReportGeneralOfCustomersDataSummary()}var e={year:$("#general-customers-year").data("DateTimePicker").date().year(),month:$("#general-customers-month").val(),day:$("#general-customers-day").val()};$.post(BaseUrl+"reports/general/customers/data",e,t,"json")}},$.ReportDirector.Init()});