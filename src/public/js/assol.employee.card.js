$(document).ready(function(){function e(e){var t={};return $.each(e,function(e,o){var a=$("#"+o);if(a.length){var s=a.is("div")?$(a).find("input:checked").val():$(a).val(),n=EmployeeRecord[o];$.isBlank(s)&&$.isBlank(n)||s==n||(t[o]=isDateField(a)?toServerDate(s):s,EmployeeRecord[o]=s)}}),t}function t(e){$("#alertErrorMessage").text(e),$("#alertError").slideDown()}function o(e){$("#alertSuccessMessage").text(e),$("#alertSuccess").slideDown()}function a(){$("#alertError").hide(),$("#alertSuccess").hide()}$.EmployeeCard={Init:function(){this.InitActions(),this.InitDynamicData(),this.InitTemplate()},InitActions:function(){$("#SavePersonalData").click(this.SavePersonalData),$("#SaveContacts").click(this.SaveContacts),$("#SaveRemove").click(this.SaveRemove),$("#SaveWork").click(this.SaveWork).click(this.SaveWorkSites),$("#SavePhotoAndVideo").click(this.SavePhotoAndVideo),$("#EmployeeRemove").click(this.EmployeeRemove),$("#EmployeeMarkRemove").click(this.EmployeeMarkRemove),$("#EmployeeRestore").click(this.EmployeeRestore),$("#EmployeeSavePassword").click(this.EmployeeSavePassword),$(document).on("click",".action-remove-agreement",function(e){confirmRemove(function(){$.EmployeeCard.RemoveAgreementRecord($(e.target).attr("record"))})}),$(document).on("click",".action-remove-passport",function(e){confirmRemove(function(){$.EmployeeCard.RemovePassportRecord($(e.target).attr("record"))})}),$(document).on("click",".action-remove-site",function(e){var t=$(e.target).closest(".work-sites-block"),o=t.attr("id-work-site"),a=t.attr("id-site");confirmRemove(function(){$.EmployeeCard.RemoveSiteRecord(a,o)})}),$(document).on("click",".action-append-customer",function(e){var t=$(e.target).closest(".work-sites-block"),o=t.attr("id-work-site"),a=t.attr("id-site"),s=$(e.target).attr("id-customer"),n=s>0?"Добавить клиента к сайту <strong>"+Sites[a]+"</strong>?":"Добавить всех клиентов привязанных к сайту <strong>"+Sites[a]+"</strong>?";bootbox.confirm(n,function(e){e&&$.EmployeeCard.SaveSiteCustomer(a,o,s)})}),$(document).on("click",".action-remove-customer",function(e){confirmRemove(function(){var t=$(e.target).closest(".work-sites-block"),o=t.attr("id-work-site"),a=t.attr("id-site");$.EmployeeCard.RemoveSiteCustomer(a,o,$(e.target).attr("record"))})}),$(document).on("click",".action-save-children",function(e){$.EmployeeCard.SaveChildrenRecord($(e.target).closest("button").attr("record"))}),$(document).on("click",".action-remove-children",function(e){confirmRemove(function(){$.EmployeeCard.RemoveChildrenRecord($(e.target).closest("button").attr("record"))})}),$(document).on("click",".action-save-relative",function(e){$.EmployeeCard.SaveRelativeRecord($(e.target).closest("button").attr("record"))}),$(document).on("click",".action-remove-relative",function(e){confirmRemove(function(){$.EmployeeCard.RemoveRelativeRecord($(e.target).closest("button").attr("record"))})}),$(document).on("click",".action-save-phone",function(e){$.EmployeeCard.SavePhoneRecord($(e.target).closest("button").attr("record"))}),$(document).on("click",".action-remove-phone",function(e){confirmRemove(function(){$.EmployeeCard.RemovePhoneRecord($(e.target).closest("button").attr("record"))})}),$(document).on("click",".action-save-email",function(e){$.EmployeeCard.SaveEmailRecord($(e.target).closest("button").attr("record"))}),$(document).on("click",".action-remove-email",function(e){confirmRemove(function(){$.EmployeeCard.RemoveEmailRecord($(e.target).closest("button").attr("record"))})}),$(document).on("click",".action-save-skype",function(e){$.EmployeeCard.SaveSkypeRecord($(e.target).closest("button").attr("record"))}),$(document).on("click",".action-remove-skype",function(e){confirmRemove(function(){$.EmployeeCard.RemoveSkypeRecord($(e.target).closest("button").attr("record"))})}),$(document).on("click",".action-save-socnet",function(e){$.EmployeeCard.SaveSocnetRecord($(e.target).closest("button").attr("record"))}),$(document).on("click",".action-remove-socnet",function(e){confirmRemove(function(){$.EmployeeCard.RemoveSocnetRecord($(e.target).closest("button").attr("record"))})}),$(document).on("keyup",".user-id-input",function(e){delay(function(){var t=$(e.target).closest(".work-sites-block").attr("id-site"),o=$(e.target).val();$.EmployeeCard.FindCustomer(t,o)},500)}),$(document).on("change","#addEmployeeAvatar",function(e){$("#AvatarForm").submit()}),$("#AvatarForm").ajaxForm(function(e){e.status?$.EmployeeCard.RefreshAvatar(e.id,e.FileName):t(e.message)}),IsLoveStory&&$(document).on("click",".action-blocked-employee",function(e){var a=$(e.target).prop("checked");bootbox.confirm((a?"Заблокировать":"Разблокировать")+" сотрудника №<strong>"+EmployeeID+"</strong>?",function(s){function n(e){e.status?o("Пользователь успешно "+(a?"заблокирован":"разблокирован")):t(e.message)}s?$.post(BaseUrl+"employee/"+EmployeeID+"/update",{data:{IsBlocked:a?1:0}},n,"json"):$(e.target).prop("checked",!a)})}),$.each(EmployeeRights,function(e,t){$("#employeeAccess_"+t.TargetEmployeeID).click()}),$("#SaveEmployeeAccess").click(function(){function e(e){e.status?o("Права пользователя успешно сохранены"):t(e.message)}var a=[];$("#employeeAccess").find("input:checked").each(function(){a.push($(this).val())});var s={Employee:EmployeeID,Employees:a};$.post(BaseUrl+"/employee/"+EmployeeID+"/rights",s,e,"json")}),$('a[href="#Contacts"]').on("shown.bs.tab",function(){$.EmployeeCard.ReloadPhoneList(),$.EmployeeCard.ReloadEmailList(),$.EmployeeCard.ReloadSkypeList(),$.EmployeeCard.ReloadSocnetList()}),$('a[href="#PhotoAndVideo"]').on("shown.bs.tab",function(){$.EmployeeCard.ReloadAgreementList(),$.EmployeeCard.ReloadPassportList()}),$('a[href="#Work"]').on("shown.bs.tab",function(){$.EmployeeCard.ReloadSiteList()})},InitDynamicData:function(){this.ReloadChildrenList(),this.ReloadRelativesList()},InitTemplate:function(){$("#childrenTemplate").template("childrenTemplate"),$("#relativeTemplate").template("relativeTemplate"),$("#phoneTemplate").template("phoneTemplate"),$("#skypeTemplate").template("skypeTemplate"),$("#emailTemplate").template("emailTemplate"),$("#socnetTemplate").template("socnetTemplate"),$("#agreementTemplate").template("agreementTemplate"),$("#passportTemplate").template("passportTemplate"),$("#siteTemplate").template("siteTemplate"),$("#clientsTemplate").template("clientsTemplate"),$("#userIdFieldTemplate").template("userIdFieldTemplate")},FindCustomer:function(e,o){function a(e){e.status?e.records?($(s).empty(),$.tmpl("userIdFieldTemplate",e.records).appendTo(s)):$(s).html("Нет данных..."):t(e.message)}var s="#UserIdField_"+e;if($(s).html("Поиск..."),o){var n=BaseUrl+"employee/"+EmployeeID+"/site/"+e+"/customer/"+o+"/find";$.post(n,{},a,"json")}else $(s).html('<a href="javascript: void(0);" class="action-append-customer" id-customer="0">Выбрать всех</a>')},RefreshAvatar:function(e,t){var o=e>0?BaseUrl+"thumb/?src=/files/images/"+t:BaseUrl+"public/img/avatar-example.png";$("#AvatarBig").attr("src",o),$("#AvatarCard").attr("src",o)},ReloadAgreementList:function(){this.ReloadData("#agreement","agreement","agreementTemplate")},ReloadPassportList:function(){this.ReloadData("#passport","passport","passportTemplate")},ReloadChildrenList:function(){this.ReloadData("#childrenList","children","childrenTemplate",{ID:0,EmployeeID:EmployeeID,SexID:0,FIO:"",DOB:""})},ReloadRelativesList:function(){this.ReloadData("#relativeList","relative","relativeTemplate",{ID:0,EmployeeID:EmployeeID,FIO:"",Occupation:""})},ReloadPhoneList:function(){this.ReloadData("#phoneList","phone","phoneTemplate",{ID:0,EmployeeID:EmployeeID,Phone:""})},ReloadEmailList:function(){this.ReloadData("#emailList","email","emailTemplate",{ID:0,EmployeeID:EmployeeID,Email:""})},ReloadSiteList:function(){this.ReloadData("#siteList","site","siteTemplate",null,function(){$(this).each(function(e,t){$.EmployeeCard.ReloadSiteCustomerList(t.ID)})})},ReloadSiteCustomerList:function(e){this.ReloadData("#ClientsList_"+e,"site/"+e+"/customer","clientsTemplate")},ReloadSkypeList:function(){this.ReloadData("#skypeList","skype","skypeTemplate",{ID:0,EmployeeID:EmployeeID,Skype:""})},ReloadSocnetList:function(){this.ReloadData("#socnetList","socnet","socnetTemplate",{ID:0,EmployeeID:EmployeeID,Socnet:""})},ReloadData:function(e,o,a,s,n){function r(o){o.status?o.records&&($(e).empty(),$.tmpl(a,o.records).appendTo(e),s&&$.tmpl(a,s).appendTo(e),"function"==typeof n&&n.call(o.records),$("input:checked").change()):t(o.message)}$(e).html("Загрузка данных...");var i=BaseUrl+"employee/"+EmployeeID+"/"+o+"/data";$.post(i,{},r,"json")},SavePersonalData:function(){function s(e){e.status?o("Личные данные успешно сохранены"):t(e.message)}a();var n=e(["SName","FName","MName","DOB","CardNumber","MaritalStatus","NameSatellite","OccupationSatellite","NameFather","OccupationFather","NameMother","OccupationMother","Forming","FormingNameInstitution","FormingFormStudy","FormingFaculty","WorkOccupation","WorkReasonLeaving","WorkLatestDirector","Smoking"]);$.isBlank(n)||$.post(BaseUrl+"employee/"+EmployeeID+"/update",{data:n},s,"json")},SaveContacts:function(){function s(e){e.status?o("Контакты успешно сохранены"):t(e.message)}a();var n=e(IsLoveStory?["Country","City","HomeAddress"]:["City","HomeAddress"]);$.isBlank(n)||$.post(BaseUrl+"employee/"+EmployeeID+"/update",{data:n},s,"json")},SaveRemove:function(){function s(e){e.status?o("Причина успешно сохранена"):t(e.message)}a();var n=e(["ReasonForDeleted","ReasonForBlocked"]);$.isBlank(n)||$.post(BaseUrl+"employee/"+EmployeeID+"/update",{data:n},s,"json")},SaveWork:function(){function s(e){e.status?o("Рабочая информация успешно сохранена"):t(e.message)}function n(e){return e.has("span").length?e.find("span").html():e.html()}a();var r=e(["UserRole"]);$.isBlank(r)||$.post(BaseUrl+"employee/"+EmployeeID+"/update",{data:r},s,"json"),IsLoveStory&&(r={Monday:n($("#Monday")),MondayNote:n($("#MondayNote")),Tuesday:n($("#Tuesday")),TuesdayNote:n($("#TuesdayNote")),Wednesday:n($("#Wednesday")),WednesdayNote:n($("#WednesdayNote")),Thursday:n($("#Thursday")),ThursdayNote:n($("#ThursdayNote")),Friday:n($("#Friday")),FridayNote:n($("#FridayNote")),Saturday:n($("#Saturday")),SaturdayNote:n($("#SaturdayNote")),Sunday:n($("#Sunday")),SundayNote:n($("#SundayNote"))},$.post(BaseUrl+"schedule/save",{employee:EmployeeID,data:r},s,"json"))},SaveWorkSites:function(){function e(e){e.status?(o("Рабочая информация успешно сохранена"),e.insert&&$.EmployeeCard.ReloadSiteList()):t(e.message)}a();var s=[];if($("#WorkSite").find("input:checked").each(function(){s.push($(this).val())}),0!=s.length){var n={sites:s};$.post(BaseUrl+"employee/"+EmployeeID+"/site/save",{data:n},e,"json")}},SavePhotoAndVideo:function(){function s(e){e.status?(o("Видео подтверждение успешно сохранено"),$("#videoConfirmFrame").attr("src",$("#VideoConfirm").val())):t(e.message)}a();var n=e(["VideoConfirm"]);$.isBlank(n)||$.post(BaseUrl+"employee/"+EmployeeID+"/update",{data:n},s,"json")},EmployeeSavePassword:function(){function s(e){e.status?o("Пароль успешно сохранен"):t(e.message)}a();var n=e(["Password"]);$.isBlank(n)||$.post(BaseUrl+"employee/"+EmployeeID+"/update",{data:n},s,"json")},SaveChildrenRecord:function(e){function s(e){e.status?(o("Ребенок успешно сохранен"),$.EmployeeCard.ReloadChildrenList()):t(e.message)}a();var n={RecordID:e,SexID:$("#ChildrenSex_"+e).find("input:radio:checked").val(),FIO:$("#ChildrenFIO_"+e).val(),DOB:toServerDate($("#ChildrenDOB_"+e).val())};$.post(BaseUrl+"employee/"+EmployeeID+"/children/save",n,s,"json")},SaveRelativeRecord:function(e){function s(e){e.status?(o("Родственник успешно сохранен"),$.EmployeeCard.ReloadRelativesList()):t(e.message)}a();var n={RecordID:e,FIO:$("#RelativeFIO_"+e).val(),Occupation:$("#RelativeOccupation_"+e).val()};$.post(BaseUrl+"employee/"+EmployeeID+"/relative/save",n,s,"json")},SavePhoneRecord:function(e){function s(e){e.status?(o("Телефон успешно сохранен"),$.EmployeeCard.ReloadPhoneList()):t(e.message)}a();var n={RecordID:e,Phone:$("#Phone_"+e).val()};$.post(BaseUrl+"employee/"+EmployeeID+"/phone/save",n,s,"json")},SaveEmailRecord:function(e){function s(e){e.status?(o("E-Mail успешно сохранен"),$.EmployeeCard.ReloadEmailList()):t(e.message)}a();var n={RecordID:e,Email:$("#Email_"+e).val()};$.post(BaseUrl+"employee/"+EmployeeID+"/email/save",n,s,"json")},SaveSkypeRecord:function(e){function s(e){e.status?(o("Skype успешно сохранен"),$.EmployeeCard.ReloadSkypeList()):t(e.message)}a();var n={RecordID:e,Skype:$("#Skype_"+e).val()};$.post(BaseUrl+"employee/"+EmployeeID+"/skype/save",n,s,"json")},SaveSocnetRecord:function(e){function s(e){e.status?(o("Социальная сеть успешно сохранена"),$.EmployeeCard.ReloadSocnetList()):t(e.message)}a();var n={RecordID:e,Socnet:$("#Socnet_"+e).val()};$.post(BaseUrl+"employee/"+EmployeeID+"/socnet/save",n,s,"json")},SaveSiteCustomer:function(e,s,n){function r(a){a.status?(o(n>0?"Клиент успешно добавлен к сайту "+Sites[e]:"Клиенты успешно добавлен к сайту "+Sites[e]),$.EmployeeCard.ReloadSiteCustomerList(s)):t(a.message)}a();var i=BaseUrl+"employee/"+EmployeeID+"/site/"+s+"/customer/"+n+"/save";$.post(i,{},r,"json")},RemoveAgreementRecord:function(e){function s(e){e.status?(o("Договор успешно удален"),$.EmployeeCard.ReloadAgreementList()):t(e.message)}a();var n=BaseUrl+"employee/"+EmployeeID+"/agreement/"+e+"/remove";$.post(n,{},s,"json")},RemovePassportRecord:function(e){function s(e){e.status?(o("Скан паспорта успешно удален"),$.EmployeeCard.ReloadPassportList()):t(e.message)}a();var n=BaseUrl+"employee/"+EmployeeID+"/passport/"+e+"/remove";$.post(n,{},s,"json")},RemoveChildrenRecord:function(e){function s(e){e.status?(o("Запись успешно удалена"),$.EmployeeCard.ReloadChildrenList()):t(e.message)}a();var n=BaseUrl+"employee/"+EmployeeID+"/children/"+e+"/remove";$.post(n,{},s,"json")},RemoveRelativeRecord:function(e){function s(e){e.status?(o("Запись успешно удалена"),$.EmployeeCard.ReloadRelativesList()):t(e.message)}a();var n=BaseUrl+"employee/"+EmployeeID+"/relative/"+e+"/remove";$.post(n,{},s,"json")},RemovePhoneRecord:function(e){function s(e){e.status?(o("Запись успешно удалена"),$.EmployeeCard.ReloadPhoneList()):t(e.message)}a();var n=BaseUrl+"employee/"+EmployeeID+"/phone/"+e+"/remove";$.post(n,{},s,"json")},RemoveEmailRecord:function(e){function s(e){e.status?(o("Запись успешно удалена"),$.EmployeeCard.ReloadEmailList()):t(e.message)}a();var n=BaseUrl+"employee/"+EmployeeID+"/email/"+e+"/remove";$.post(n,{},s,"json")},RemoveSkypeRecord:function(e){function s(e){e.status?(o("Запись успешно удалена"),$.EmployeeCard.ReloadSkypeList()):t(e.message)}a();var n=BaseUrl+"employee/"+EmployeeID+"/skype/"+e+"/remove";$.post(n,{},s,"json")},RemoveSiteCustomer:function(e,s,n){function r(e){e.status?(o("Запись успешно удалена"),$.EmployeeCard.ReloadSiteCustomerList(s)):t(e.message)}a();var i=BaseUrl+"employee/"+EmployeeID+"/site/"+e+"/customer/"+n+"/remove";$.post(i,{},r,"json")},RemoveSocnetRecord:function(e){function s(e){e.status?(o("Запись успешно удалена"),$.EmployeeCard.ReloadSocnetList()):t(e.message)}a();var n=BaseUrl+"employee/"+EmployeeID+"/socnet/"+e+"/remove";$.post(n,{},s,"json")},RemoveSiteRecord:function(e,s){function n(a){a.status?(o("Запись успешно удалена"),$.EmployeeCard.ReloadSiteList(),$("#WorkSite_"+e).click()):t(a.message)}a();var r=BaseUrl+"employee/"+EmployeeID+"/site/"+s+"/remove";$.post(r,{},n,"json")},EmployeeRemove:function(){confirmRemove(function(){function e(e){e.status?(alert("Запись успешно удалена"),window.location=BaseUrl+"employee"):t(e.message)}a();var o=BaseUrl+"employee/"+EmployeeID+"/remove";$.post(o,{IsFull:!0},e,"json")},"Вы действительно хотите БЕЗВОЗВРАТНО удалить запись?")},EmployeeMarkRemove:function(){confirmRemove(function(){function e(e){e.status?o("Запись успешно удалена"):t(e.message)}a();var s=BaseUrl+"employee/"+EmployeeID+"/remove";$.post(s,{},e,"json")})},EmployeeRestore:function(){function e(e){e.status?o("Запись успешно восстановлена"):t(e.message)}a();var s=BaseUrl+"employee/"+EmployeeID+"/restore";$.post(s,{},e,"json")}},$.EmployeeCard.Init(),$('a[data-toggle="tab"]').on("shown.bs.tab",function(){a()}),$("body").on("hidden.bs.modal",".remoteModal",function(){$(this).removeData("bs.modal")})});