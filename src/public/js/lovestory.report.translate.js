$(document).ready(function(){"use strict";$.ReportTranslate={Init:function(){this.InitActions(),this.InitTemplate(),this.InitDynamicData()},InitActions:function(){function t(t,a,e){var r=a;switch(e||"number"){case"number":a=a>0?a:"";break;case"decimal":a=a>0?a:""}if(null!=$(t).contentEditable)$(t).attr("contentEditable",isEdit);else{var o=$("<input/>",{type:"text",min:0,value:a}).attr("last-value",r);switch($(t).html(o),e||"number"){case"number":o.numeric();break;case"decimal":o.numeric(),o.keydown(function(t){if("188"==t.keyCode||"188"==t.charCode||"110"==t.keyCode||"110"==t.charCode){t.preventDefault();var a=$(t.target),e=a.val().indexOf(".");if(e>0)return;a.val(a.val()+".")}})}o.focus()}}$(document).on("click",".is-edit>div",function(){var a=0==$.ReportTranslate.getEmployee();if(a){var e=$(this).parent();t(e,e.find("div").html(),"decimal")}}),$(document).on("focusout","#ReportIndividualDaily_data tbody .is-edit>input",function(){function t(t){e.html($("<div/>",{text:t}))}function a(a){a.status?(t(o),$.ReportTranslate.RefreshReportDailyDataSummary()):(t(r),alert("Ошибка сохранения данных"))}var e=$(this).parent(),r=parseFloat($(this).attr("last-value")),o=parseFloat($(this).val()||0);if(r!=o){var i=moment([$("#daily-year").data("DateTimePicker").date().year(),$("#daily-month").val(),$(this).closest("[day]").attr("day")]).format("YYYY-MM-DD"),l={dateRecord:i,idCross:e.attr("id-work-site")};l[e.hasClass("mail")?"mails":"chat"]=o,$.post(BaseUrl+"reports/lovestory/daily/save",l,a,"json")}else t(r)}),$(document).on("focusout","#ReportIndividualDaily_data thead .is-edit>input",function(){function t(t){e.html($("<div/>",{text:t}))}function a(a){a.status?(t(o),$.ReportTranslate.RefreshReportDailyDataSummary()):(t(r),alert("Ошибка сохранения данных"))}var e=$(this).parent(),r=parseFloat($(this).attr("last-value")),o=parseFloat($(this).val()||0);if(r!=o){var i={year:$("#daily-year").data("DateTimePicker").date().year(),month:$("#daily-month").val(),idCross:e.attr("id-work-site")};i[e.hasClass("mail")?"mails":"chat"]=o,$.post(BaseUrl+"reports/lovestory/daily/plan/save",i,a,"json")}else t(r)}),$("#submit-report-salary").click(function(){function t(t){t.status?alert("Данные успешно отправлены в сводную таблицу"):alert("Ошибка: "+t.message)}var a={employee:$.ReportTranslate.getEmployee(),year:$("#salary-year").data("DateTimePicker").date().year(),month:$("#salary-month").val()};$.post(BaseUrl+"reports/salary/close",a,t,"json")}),$(document).on("click","#ReportIndividualSalary_data>tbody>tr>td[type]>div",function(){if(0==$.ReportTranslate.getEmployee()){var a=$(this).parent().hasClass("decimal")?"decimal":"number";t($(this).parent(),$(this).html(),a)}}),$(document).on("focusout","#ReportIndividualSalary_data td[type]>input",function(){function t(t){e.html($("<div/>",{text:t}))}function a(a){a.status?(t(i),$.ReportTranslate.RefreshReportSalaryDataSummary()):(t(o),alert("Ошибка: "+a.message))}var e=$(this).parent(),r=e.hasClass("decimal"),o=r?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),i=r?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(o!=i){var l=$("#salary-year").data("DateTimePicker").date().year(),d=$("#salary-month").val(),n=e.attr("type"),s={idEmployeeSite:e.closest("tr").attr("id-employee-site"),year:l,month:d,type:n,value:i};$.post(BaseUrl+"reports/salary/save",s,a,"json")}else t(o)})},InitDynamicData:function(){},InitTemplate:function(){$("#reportIndividualDailyTemplate").template("reportIndividualDailyTemplate"),$("#reportIndividualDaily_fixedWrapBody_Template").template("reportIndividualDaily_fixedWrapBody_Template"),$("#reportIndividualSalaryTemplate").template("reportIndividualSalaryTemplate"),$("#reportApprovedSalaryTemplate").template("reportApprovedSalaryTemplate"),$("#reportAllocation_Template").template("reportAllocation_Template")},ReloadReportMountMeta:function(t){function a(){return r.data("DateTimePicker").date().year()}function e(e){if(e.status){var r=t||a(),i=o.val(),l=moment([r,i]).endOf("month").date();e.records.days=[];for(var d=1;d<=l;d++)e.records.days.push({day:d,date:moment([r,i,d]).format("YYYY-MM-DD")});$.tmpl("reportIndividualDailyTemplate",e.records).appendTo("#ReportIndividualDaily_data"),$.tmpl("reportIndividualDaily_fixedWrapBody_Template",e.records.days).appendTo("#ReportIndividualDaily_fixedWrapBody>tbody"),$.ReportTranslate.ReloadReportMountPlanData(t||a(),o.val())}}$("#ReportIndividualDaily_data").empty(),$("#ReportIndividualDaily_fixedWrapBody").find(">tbody").empty();var r=$("#daily-year"),o=$("#daily-month"),i={employee:$.ReportTranslate.getEmployee()};$.post(BaseUrl+"reports/lovestory/daily/meta",i,e,"json")},ReloadReportMountPlanData:function(t,a){function e(e){var r=$("#ReportIndividualDaily_data").find(">thead");$.each(e.records,function(t,a){var e=r.find('th[id-work-site="'+a.esID+'"]');$(e[0]).find("div").html(a.emails||0),$(e[1]).find("div").html(a.chat||0)}),$.ReportTranslate.ReloadReportMountData(t,a)}var r={employee:$.ReportTranslate.getEmployee(),year:t,month:a};$.post(BaseUrl+"reports/lovestory/daily/plan/data",r,e,"json")},ReloadReportMountData:function(t,a){function e(t){var a=$("#ReportIndividualDaily_data").find(">tbody");$.each(t.records,function(t,e){var r=a.find('td[date="'+e.date+'"][id-work-site="'+e.esID+'"]');$(r[0]).find("div").html(e.emails||0),$(r[1]).find("div").html(e.chat||0)}),$.ReportTranslate.RefreshReportDailyDataSummary()}var r={employee:$.ReportTranslate.getEmployee(),year:t,month:a};$.post(BaseUrl+"reports/lovestory/daily/data",r,e,"json")},RefreshReportDailyDataSummary:function(){var t=$("#ReportIndividualDaily_data"),a=$("#ReportIndividualDaily_fixedWrapBody");$(t).find("tfoot td[id]").html(0),$(a).find("tbody td, tfoot td").html(0);var e=0,r=0;$(t).find("thead .mail").each(function(){e+=parseFloat($(this).find("div").html())}),$(t).find("thead .chat").each(function(){r+=parseFloat($(this).find("div").html())});var o=$("#rid_plan_total");o.find("th:eq(0)").html(e.toFixed(2)),o.find("th:eq(1)").html(r.toFixed(2)),o.find("th:eq(2)").html((e+r).toFixed(2)),$(t).find("tbody .mail").each(function(){var t=$(this).attr("id-work-site"),a=$("#foot_mail_total_"+t);a.html((parseFloat(a.html())+parseFloat($(this).find("div").html())).toFixed(2));var e=parseFloat($("#plan_mail_"+t).find("div").html()),r=$("#foot_mail_bal_"+t);r.html((e-parseFloat(a.html())).toFixed(2));var o=$(this).closest("tr").attr("day"),i=$("#rid_total_"+o).find("td:eq(0)");i.html((parseFloat(i.html())+parseFloat($(this).find("div").html())).toFixed(2))}),$(t).find("tbody .chat").each(function(){var t=$(this).attr("id-work-site"),a=$("#foot_chat_total_"+t);a.html((parseFloat(a.html())+parseFloat($(this).find("div").html())).toFixed(2));var e=parseFloat($("#plan_chat_"+t).find("div").html()),r=$("#foot_chat_bal_"+t);r.html((e-parseFloat(a.html())).toFixed(2));var o=$(this).closest("tr").attr("day"),i=$("#rid_total_"+o),l=i.find("td:eq(0)"),d=i.find("td:eq(1)"),n=i.find("td:eq(2)");d.html((parseFloat(d.html())+parseFloat($(this).find("div").html())).toFixed(2)),n.html((parseFloat(d.html())+parseFloat(l.html())).toFixed(2))});var i=$(a).find("tfoot>tr:eq(0)"),l=i.find("td:eq(0)"),d=i.find("td:eq(1)"),n=i.find("td:eq(2)");$(a).find("tbody>tr").each(function(){l.html((parseFloat(l.html())+parseFloat($(this).find("td:eq(0)").html())).toFixed(2)),d.html((parseFloat(d.html())+parseFloat($(this).find("td:eq(1)").html())).toFixed(2)),n.html((parseFloat(n.html())+parseFloat($(this).find("td:eq(2)").html())).toFixed(2))});var s=$(a).find("tfoot>tr:eq(1)");s.find("td:eq(0)").html((e-parseFloat(l.html())).toFixed(2)),s.find("td:eq(1)").html((r-parseFloat(d.html())).toFixed(2)),s.find("td:eq(2)").html((e+r-parseFloat(n.html())).toFixed(2))},ReloadReportSalary:function(){function t(t){t.status?($.tmpl("reportIndividualSalaryTemplate",t.records).appendTo(a),$.ReportTranslate.RefreshReportSalaryDataSummary()):alert("Ошибка получения данных")}var a=$("#ReportIndividualSalary_data").find(">tbody");a.empty();var e={employee:$.ReportTranslate.getEmployee(),year:$("#salary-year").data("DateTimePicker").date().year(),month:$("#salary-month").val()};$.post(BaseUrl+"reports/salary/data",e,t,"json")},RefreshReportSalaryDataSummary:function(){var t=$("#ReportIndividualSalary_data");$(t).find("tr").find("td:last").html(0),$(t).find("tbody>tr").each(function(){var t=parseFloat($(this).find("td:eq(2) div").html())||0,a=parseFloat($(this).find("td:eq(4) div").html())||0,e=parseFloat($(this).find("td:eq(6) div").html())||0,r=parseFloat($(this).find("td:eq(8) div").html())||0;$(this).find("td:last").html((t+a+e+r).toFixed(2))});var a=$(t).find("tfoot td:last");$(t).find("tbody>tr").find("td:last").each(function(){var t=parseFloat($(this).html())||0,e=parseFloat(a.html())||0;a.html((e+t).toFixed(2))})},ReloadReportApprovedSalary:function(t){function a(t){t.status?$.tmpl("reportApprovedSalaryTemplate",t.records).appendTo(e):alert("Ошибка получения данных")}var e=$("#ReportApprovedSalary_data").find(">tbody");e.empty();var r={year:t||$("#approved-salary-year").data("DateTimePicker").date().year(),month:$("#approved-salary-month").val()};$.post(BaseUrl+"reports/approved/salary/data",r,a,"json")},ReloadReportAllocation:function(){function t(t){t.status?$.tmpl("reportAllocation_Template",t.records).appendTo(a):alert("Ошибка получения данных")}var a=$("#ReportAllocation_data").find(">tbody");a.empty(),$.post(BaseUrl+"reports/lovestory/allocation/data",{},t,"json")},employee:0,setEmployee:function(t){this.employee=t},getEmployee:function(){return this.employee}},$.ReportTranslate.Init()});