$(document).ready(function(){"use strict";$.ReportTranslate={Init:function(){this.InitActions(),this.InitTemplate(),this.InitDynamicData()},InitActions:function(){function e(e,t,a){var r=t;switch(a||"number"){case"number":t=t>0?t:"";break;case"decimal":t=t>0?t:""}if(null!=$(e).contentEditable)$(e).attr("contentEditable",isEdit);else{var o=$("<input/>",{type:"text",min:0,value:t}).attr("last-value",r);switch($(e).html(o),a||"number"){case"number":o.numeric();break;case"decimal":o.numeric(),o.keydown(function(e){if("188"==e.keyCode||"188"==e.charCode||"110"==e.keyCode||"110"==e.charCode){e.preventDefault();var t=$(e.target),a=t.val().indexOf(".");if(a>0)return;t.val(t.val()+".")}})}o.focus()}}$(document).on("click",".is-edit>div",function(){var t=$(this).parent();e(t,t.find("div").html())}),$(document).on("focusout",".is-edit>input",function(){function e(e){a.html($("<div/>",{text:e}))}function t(t){t.status?(e(o),$.ReportTranslate.RefreshReportDailyDataSummary()):(e(r),alert("Ошибка сохранения данных"))}var a=$(this).parent(),r=parseFloat($(this).attr("last-value")),o=parseFloat($(this).val()||0);if(r!=o){var i=moment([$("#daily-year").data("DateTimePicker").date().year(),$("#daily-month").val(),$("#daily-day").val()]).format("YYYY-MM-DD"),n={dateRecord:i,idCross:a.attr("id-cross")};n[a.hasClass("mail")?"mails":"chat"]=o,$.post(BaseUrl+"reports/daily/save",n,t,"json")}else e(r)}),$(document).on("click","#mailingSite input:radio",function(e){$.ReportTranslate.ReloadReportMailingMeta($(e.target).val())}),$(document).on("click","#ReportIndividualMailing_data td[day]>div",function(){if(0==$.ReportTranslate.getEmployee()){var t=102==$(this).parent().attr("day");e($(this).parent(),$(this).html(),t?"text":"number")}}),$(document).on("focusout","#ReportIndividualMailing_data td[day]>input",function(){function e(e){a.html($("<div/>",{text:e}))}function t(t){t.status?e(i):(e(o),alert("Ошибка сохранения данных"))}var a=$(this).parent(),r=parseInt(a.attr("day")),o=parseInt($(this).attr("last-value")||0),i=102!=r?parseInt($(this).val()||0):$(this).val();if(o!=i){var n=$("#mailing-year").data("DateTimePicker").date().year(),d=$("#mailing-month").val(),l={idCross:a.closest("tr").attr("id-cross")};101==r?(l.year=n,l.month=d,l.id=i):102==r?(l.year=n,l.month=d,l.age=i):(l.dateRecord=moment([n,d,r]).format("YYYY-MM-DD"),l.value=i),$.post(BaseUrl+"reports/mailing/save",l,t,"json")}else e(o)}),$(document).on("click",".action-correspondence-remove",function(e){function t(e){e.status?$.ReportTranslate.ReloadReportCorrespondenceMeta():alert("Ошибка: "+e.message)}var a=$(e.target).closest("[id-record]").attr("id-record");confirmRemove(function(){$.post(BaseUrl+"reports/correspondence/remove",{record:a},t,"json")})}),$(document).on("click","#ReportIndividualCorrespondence_data td[day]>div",function(){if(0==$.ReportTranslate.getEmployee()){var t=$(this).parent().attr("day");102==t||104==t?e($(this).parent(),$(this).html()):e($(this).parent(),$(this).html(),"text")}}),$(document).on("focusout","#ReportIndividualCorrespondence_data td[day]>input",function(){function e(e){a.html($("<div/>",{text:e}))}function t(t){t.status?e(n):(e(i),alert("Ошибка сохранения данных"))}var a=$(this).parent(),r=parseInt(a.attr("day")),o=102==r||104==r,i=o?parseInt($(this).attr("last-value")||0):$(this).attr("last-value"),n=o?parseInt($(this).val()||0):$(this).val();if(i!=n){var d=$("#correspondence-year").data("DateTimePicker").date().year(),l=$("#correspondence-month").val(),s={idRecord:a.closest("tr").attr("id-record")};if(r<=31)s.dateRecord=moment([d,l,r]).format("YYYY-MM-DD"),s.value=n;else switch(s.year=d,s.month=l,r){case 102:s.idInfo=n;break;case 103:s.menInfo=n;break;case 104:s.idMenInfo=n}$.post(BaseUrl+"reports/correspondence/save",s,t,"json")}else e(i)}),$(document).on("click","#correspondenceSite input:radio",function(e){$.ReportTranslate.ReloadReportCorrespondenceMeta($(e.target).val())}),$("#addCorrespondenceRecord").click(function(){function e(){$("#addCorrespondenceRecordForm").modal("hide"),$.ReportTranslate.ReloadReportCorrespondenceMeta()}var t=$("#correspondenceCustomer").find("input:radio:checked").val();if(t){var a={employee:$.ReportTranslate.getEmployee(),es2c:t,year:$("#correspondence-year").data("DateTimePicker").date().year(),month:$("#correspondence-month").val(),SiteID:$("#correspondenceSite").find("input:radio:checked").val(),offset:$("#addCorrespondenceRecordOffset").val()};$.post(BaseUrl+"reports/correspondence/save",a,e,"json")}else alert("Не выбран клиент!")}),$("#submit-report-salary").click(function(){function e(e){e.status?alert("Данные успешно отправлены в сводную таблицу"):alert("Ошибка: "+e.message)}var t={employee:$.ReportTranslate.getEmployee(),year:$("#salary-year").data("DateTimePicker").date().year(),month:$("#salary-month").val()};$.post(BaseUrl+"reports/salary/close",t,e,"json")}),$(document).on("click","#ReportIndividualSalary_data>tbody>tr>td[type]>div",function(){if(0==$.ReportTranslate.getEmployee()){var t=$(this).parent().hasClass("decimal")?"decimal":"number";e($(this).parent(),$(this).html(),t)}}),$(document).on("focusout","#ReportIndividualSalary_data td[type]>input",function(){function e(e){a.html($("<div/>",{text:e}))}function t(t){t.status?(e(i),$.ReportTranslate.RefreshReportSalaryDataSummary()):(e(o),alert("Ошибка: "+t.message))}var a=$(this).parent(),r=a.hasClass("decimal"),o=r?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),i=r?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(o!=i){var n=$("#salary-year").data("DateTimePicker").date().year(),d=$("#salary-month").val(),l=a.attr("type"),s={idEmployeeSite:a.closest("tr").attr("id-employee-site"),year:n,month:d,type:l,value:i};$.post(BaseUrl+"reports/salary/save",s,t,"json")}else e(o)})},InitDynamicData:function(){},InitTemplate:function(){$("#reportIndividualDailyTemplate").template("reportIndividualDailyTemplate"),$("#reportIndividualMailingTemplate").template("reportIndividualMailingTemplate"),$("#reportIndividualSalaryTemplate").template("reportIndividualSalaryTemplate"),$("#reportIndividualCorrespondenceTemplate").template("reportIndividualCorrespondenceTemplate"),$("#reportIndividualDaily_fixedWrapBody_Template").template("reportIndividualDaily_fixedWrapBody_Template"),$("#reportIndividualDaily_total_Template").template("reportIndividualDaily_total_Template"),$("#workSitesTemplate").template("workSitesTemplate"),$("#correspondenceCustomerTemplate").template("correspondenceCustomerTemplate"),$("#reportApprovedSalaryTemplate").template("reportApprovedSalaryTemplate")},RefreshReportDailyDate:function(e){function t(){return a.data("DateTimePicker").date().year()}var a=$("#daily-year"),r=$("#daily-month"),o=$("#daily-day"),i=moment([e||t(),r.val()]).endOf("month").date();o.empty(),o.append($("<option/>",{value:0,text:"за месяц"}));for(var n=1;n<=i;n++)o.append($("<option/>",{value:n,text:n}));r.val()==moment().month()&&o.find("[value='"+moment().date()+"']").attr("selected","selected"),$.ReportTranslate.ReloadReportDailyData()},ReloadReportDailyMeta:function(){function e(e){e.status&&($.tmpl("reportIndividualDailyTemplate",e.records).appendTo("#ReportIndividualDaily_data"),$.tmpl("reportIndividualDaily_fixedWrapBody_Template",e.records.customers).appendTo("#ReportIndividualDaily_fixedWrapBody>tbody"),$.tmpl("reportIndividualDaily_total_Template",e.records.customers).appendTo("#ReportIndividualDaily_total>tbody"),$.ReportTranslate.RefreshReportDailyDate())}$("#ReportIndividualDaily_data").empty(),$("#ReportIndividualDaily_fixedWrapBody").find(">tbody").empty(),$("#ReportIndividualDaily_total").find(">tbody").empty();var t={employee:$.ReportTranslate.getEmployee()};$.post(BaseUrl+"reports/daily/meta",t,e,"json")},ReloadReportDailyData:function(){function e(e){function t(e,t,a,r,o,i,n){t?e.addClass("is-edit"):e.removeClass("is-edit"),e.addClass(a).attr("id-cross",r).attr("id-customer",o).attr("id-employee-site",i).find("div").html(n||0)}$("#ReportIndividualDaily_data").find(".mail div, .chat div").html(0),$.each(e.records,function(e,r){var o=r.CustomerID+"_"+r.EmployeeSiteID;t($("#mail_"+o),a,"mail",r.es2cID,r.CustomerID,r.EmployeeSiteID,r.emails),t($("#chat_"+o),a,"chat",r.es2cID,r.CustomerID,r.EmployeeSiteID,r.chat)}),$.ReportTranslate.RefreshReportDailyDataSummary()}var t={employee:$.ReportTranslate.getEmployee(),year:$("#daily-year").data("DateTimePicker").date().year(),month:$("#daily-month").val(),day:$("#daily-day").val()},a=0==$.ReportTranslate.getEmployee()&&t.day>0&&t.month==moment().month();$.post(BaseUrl+"reports/daily/data",t,e,"json")},RefreshReportDailyDataSummary:function(){var e=$("#ReportIndividualDaily_data"),t=$("#ReportIndividualDaily_total"),a=$("#ReportIndividualDaily_fixedWrapBody");$(e).find("tfoot td div").html(0),$(t).find("tbody td, tfoot td").html(0),$(a).find("tbody td, tfoot td").html(0),$(e).find("tbody .mail").each(function(){var e=$(this).attr("id-employee-site"),t=$("#foot_mail_"+e);t.html(parseFloat(t.html())+parseFloat($(this).find("div").html()));var a=$(this).attr("id-customer"),r=$("#rid_total_"+a).find("td:eq(0)");r.html(parseFloat(r.html())+parseFloat($(this).find("div").html()))}),$(e).find("tbody .chat").each(function(){var e=$(this).attr("id-employee-site"),t=$("#foot_chat_"+e);t.html(parseFloat(t.html())+parseFloat($(this).find("div").html()));var a=$(this).attr("id-customer"),r=$("#rid_total_"+a),o=r.find("td:eq(0)"),i=r.find("td:eq(1)"),n=r.find("td:eq(2)");i.html(parseFloat(i.html())+parseFloat($(this).find("div").html())),n.html(parseFloat(i.html())+parseFloat(o.html())),$("#rid_slide_total_"+a).find("td").html(n.html())});var r=$(t).find("tfoot>tr"),o=r.find("td:eq(0)"),i=r.find("td:eq(1)"),n=r.find("td:eq(2)");$(t).find("tbody>tr").each(function(){o.html(parseFloat(o.html())+parseFloat($(this).find("td:eq(0)").html())),i.html(parseFloat(i.html())+parseFloat($(this).find("td:eq(1)").html())),n.html(parseFloat(n.html())+parseFloat($(this).find("td:eq(2)").html()))}),$(a).find("tfoot>tr>td").html(n.html())},ReloadReportMailing:function(){function e(e){e.status?($.tmpl("workSitesTemplate",e.records).appendTo(t),t.find("input:first").click()):alert("Ошибка получения списка сайтов")}var t=$("#mailingSite").find("ul");t.empty(),$.post(BaseUrl+"reports/sites",{employee:$.ReportTranslate.getEmployee()},e,"json")},ReloadReportMailingMeta:function(e){function t(e){if(e.status){var t=$("#mailing-year").data("DateTimePicker").date().year(),a=$("#mailing-month").val(),r=moment([t,a]).endOf("month").date();e.records.days=[];for(var o=1;o<=r;o++)e.records.days.push(o);$.tmpl("reportIndividualMailingTemplate",e.records).appendTo("#ReportIndividualMailing_data"),$.ReportTranslate.ReloadReportMailingData()}}e=e||$("#mailingSite").find("input:radio:checked").val(),$("#ReportIndividualMailing_data").empty();var a={employee:$.ReportTranslate.getEmployee(),SiteID:e};$.post(BaseUrl+"reports/mailing/meta",a,t,"json")},ReloadReportMailingData:function(){function e(e){e.status?($.each(e.records.days,function(e,t){var a=t.EmployeeSiteCustomerID,r=moment(t.date).date();$("#ReportIndividualMailing_data").find('tbody>tr[id-cross="'+a+'"]>td[day="'+r+'"]>div').html(t.value)}),$.each(e.records.info,function(e,t){var a=t.EmployeeSiteCustomerID,r=t["id-info"],o=t["age-info"];r>0&&$("#ReportIndividualMailing_data").find('tbody>tr[id-cross="'+a+'"]>td[day="101"]>div').html(r),$("#ReportIndividualMailing_data").find('tbody>tr[id-cross="'+a+'"]>td[day="102"]>div').html(o)})):alert("Ошибка получения данных")}var t={employee:$.ReportTranslate.getEmployee(),year:$("#mailing-year").data("DateTimePicker").date().year(),month:$("#mailing-month").val(),SiteID:$("#mailingSite").find("input:radio:checked").val()};$.post(BaseUrl+"reports/mailing/data",t,e,"json")},ReloadReportCorrespondence:function(){function e(e){e.status?($.tmpl("workSitesTemplate",e.records).appendTo(t),t.find("input:first").click()):alert("Ошибка получения списка сайтов")}var t=$("#correspondenceSite").find("ul");t.empty(),$.post(BaseUrl+"reports/sites",{employee:$.ReportTranslate.getEmployee()},e,"json")},ReloadReportCorrespondenceCustomers:function(){function e(e){e.status?($.tmpl("correspondenceCustomerTemplate",e.records).appendTo(r),r.find("input:first").click()):alert("Ошибка получения данных")}var t={employee:$.ReportTranslate.getEmployee(),SiteID:$("#correspondenceSite").find("input:radio:checked").val()},a=$("#correspondenceCustomer"),r=a.find("ul");r.empty(),a.find(".label-placement-wrap button").html("Выбрать"),$.post(BaseUrl+"reports/correspondence/customers",t,e,"json")},ReloadReportCorrespondenceMeta:function(e){function t(e){if(e.status){var t=$("#correspondence-year").data("DateTimePicker").date().year(),a=$("#correspondence-month").val(),r=moment([t,a]).endOf("month").date();e.records.days=[];for(var o=1;o<=r;o++)e.records.days.push(o);$.tmpl("reportIndividualCorrespondenceTemplate",e.records).appendTo("#ReportIndividualCorrespondence_data"),$.ReportTranslate.ReloadReportCorrespondenceData(),$.ReportTranslate.ReloadReportCorrespondenceCustomers()}}e=e||$("#correspondenceSite").find("input:radio:checked").val(),$("#ReportIndividualCorrespondence_data").empty();var a={employee:$.ReportTranslate.getEmployee(),year:$("#correspondence-year").data("DateTimePicker").date().year(),month:$("#correspondence-month").val(),SiteID:e};$.post(BaseUrl+"reports/correspondence/meta",a,t,"json")},ReloadReportCorrespondenceData:function(){function e(e){e.status?$.each(e.records,function(e,t){var a=t.CorrespondenceInfoID,r=moment(t.date).date();$("#ReportIndividualCorrespondence_data").find('tbody>tr[id-record="'+a+'"]>td[day="'+r+'"]>div').html(t.value)}):alert("Ошибка получения данных")}var t={employee:$.ReportTranslate.getEmployee(),year:$("#correspondence-year").data("DateTimePicker").date().year(),month:$("#correspondence-month").val(),SiteID:$("#correspondenceSite").find("input:radio:checked").val()};$.post(BaseUrl+"reports/correspondence/data",t,e,"json")},ReloadReportSalary:function(){function e(e){e.status?($.tmpl("reportIndividualSalaryTemplate",e.records).appendTo(t),$.ReportTranslate.RefreshReportSalaryDataSummary()):alert("Ошибка получения данных")}var t=$("#ReportIndividualSalary_data").find(">tbody");t.empty();var a={employee:$.ReportTranslate.getEmployee(),year:$("#salary-year").data("DateTimePicker").date().year(),month:$("#salary-month").val()};$.post(BaseUrl+"reports/salary/data",a,e,"json")},RefreshReportSalaryDataSummary:function(){var e=$("#ReportIndividualSalary_data");$(e).find("tr").find("td:last").html(0),$(e).find("tbody>tr").each(function(){var e=parseFloat($(this).find("td:eq(2) div").html())||0,t=parseFloat($(this).find("td:eq(4) div").html())||0,a=parseFloat($(this).find("td:eq(6) div").html())||0,r=parseFloat($(this).find("td:eq(8) div").html())||0;$(this).find("td:last").html((e+t+a+r).toFixed(2))});var t=$(e).find("tfoot td:last");$(e).find("tbody>tr").find("td:last").each(function(){var e=parseFloat($(this).html())||0,a=parseFloat(t.html())||0;t.html((a+e).toFixed(2))})},ReloadReportApprovedSalary:function(e){function t(e){if(e.status){$.tmpl("reportApprovedSalaryTemplate",e.records).appendTo(a);var t=$("#ReportApprovedSalary_data").find(">tfoot"),r=t.find("strong:eq(0)"),o=t.find("strong:eq(1)"),i=t.find("strong:eq(2)");t.find("strong").html(0),a.find("tr").each(function(){var e=1==parseFloat($(this).attr("paid")),t=parseFloat($(this).find("td:eq(1)").html());r.html((parseFloat(r.html())+t).toFixed(2)),e?o.html((parseFloat(o.html())+t).toFixed(2)):i.html((parseFloat(i.html())+t).toFixed(2))})}else alert("Ошибка получения данных")}var a=$("#ReportApprovedSalary_data").find(">tbody");a.empty();var r={year:e||$("#approved-salary-year").data("DateTimePicker").date().year(),month:$("#approved-salary-month").val()};$.post(BaseUrl+"reports/approved/salary/data",r,t,"json")},employee:0,setEmployee:function(e){this.employee=e},getEmployee:function(){return this.employee}},$.ReportTranslate.Init()});