$(document).ready(function(){"use strict";$.ReportDirector={Init:function(){this.InitActions(),this.InitTemplate(),this.InitDynamicData()},InitActions:function(){function e(e,t,a){var r=t;switch(a||"number"){case"number":t=t>0?t:"";break;case"decimal":t=t>0?t:""}if(null!=$(e).contentEditable)$(e).attr("contentEditable",isEdit);else{var l=$("<input/>",{type:"text",min:0,value:t}).attr("last-value",r);switch(a||"number"){case"number":l.numeric();break;case"decimal":l.numeric(),l.keydown(function(e){if("188"==e.keyCode||"188"==e.charCode||"110"==e.keyCode||"110"==e.charCode){e.preventDefault();var t=$(e.target),a=t.val().indexOf(".");if(a>0)return;t.val(t.val()+".")}})}$(e).html(l),l.focus()}}$(document).on("click","#ReportOverallSalary_data a.confirm",function(){function e(e){e.status?(t.html("подтверждено"),alert("Данные успешно отправлены в общую таблицу з/п")):alert("Ошибка: "+e.message)}var t=$(this).closest("td"),a={SiteID:$("#overlaySalarySite").find("input:radio:checked").val(),employee:$(this).closest("tr").attr("id-employee"),year:$("#overlay-salary-year").data("DateTimePicker").date().year(),month:$("#overlay-salary-month").val()};$.post(BaseUrl+"reports/overlay/salary/close",a,e,"json")}),$(document).on("click","#overlaySalarySite input:radio",function(e){$.ReportDirector.ReloadReportOverallSalary($(e.target).val())}),$(document).on("click","#ReportOverallSalary_data>tbody>tr>td[type]>div",function(){var t=$(this).parent().hasClass("decimal")?"decimal":"number";e($(this).parent(),$(this).html(),t)}),$(document).on("focusout","#ReportOverallSalary_data td[type]>input",function(){function e(e){a.html($("<div/>",{text:e}))}function t(t){if(t.status){e(o);var r=a.attr("original")||0;o!=r?a.addClass("editable-cell"):a.removeClass("editable-cell");var i=a.closest("tr").find(".status");"подтверждено"==i.html()&&i.html('<a href="#" class="confirm">подтвердить</a>'),$.ReportDirector.RefreshReportOverallSalaryDataSummary()}else e(l),alert("Ошибка: "+t.message)}var a=$(this).parent(),r=a.hasClass("decimal"),l=r?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),o=r?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(l!=o){var i=$("#overlay-salary-year").data("DateTimePicker").date().year(),n=$("#overlay-salary-month").val(),s=a.attr("type"),d={SiteID:$("#overlaySalarySite").find("input:radio:checked").val(),idEmployee:a.closest("tr").attr("id-employee"),year:i,month:n,type:s,value:o};$.post(BaseUrl+"reports/overlay/salary/save",d,t,"json")}else e(l)}),$(document).on("click","#ReportGeneralSalary_data thead td[id-site]>div",function(){e($(this).parent(),$(this).html())}),$(document).on("focusout","#ReportGeneralSalary_data thead td[id-site]>input",function(){function e(e){a.html($("<div/>",{text:e}))}function t(t){t.status?(e(o),$.ReportDirector.ReloadReportGeneralSalaryDataSummary()):(e(l),alert("Ошибка: "+t.message))}var a=$(this).parent(),r=a.hasClass("decimal"),l=r?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),o=r?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(l!=o){var i=$("#general-salary-year").data("DateTimePicker").date().year(),n=$("#general-salary-month").val(),s={idEmployee:a.closest("tr").attr("id-employee"),idSite:a.attr("id-site"),year:i,month:n,value:o};$.post(BaseUrl+"reports/general/salary/save",s,t,"json")}else e(l)}),$(document).on("click","#ReportGeneralSalary_data .is-repay-tooltip .yes",function(){function e(e){e.status?t.addClass("repay"):alert("Ошибка: "+e.message)}var t=$(this).closest("td"),a={idRecord:t.find("div[id-record]").attr("id-record"),paid:1};$.post(BaseUrl+"reports/general/salary/paid",a,e,"json")}),$(document).on("click","#ReportGeneralSalary_data .is-repay-tooltip .no",function(){function e(e){e.status?t.removeClass("repay"):alert("Ошибка: "+e.message)}var t=$(this).closest("td"),a={idRecord:t.find("div[id-record]").attr("id-record"),paid:0};$.post(BaseUrl+"reports/general/salary/paid",a,e,"json")}),$(document).on("click","#ReportGeneralOfEmployees_data .is-edit>div",function(){e($(this).parent(),$(this).html(),"decimal")}),$(document).on("click","#generalSite input:radio",function(){$.ReportDirector.ReloadGeneralOfEmployeesMeta($(this).val())}),$(document).on("focusout","#ReportGeneralOfEmployees_data .is-edit>input",function(){function e(e){a.html($("<div/>",{text:e}))}function t(t){t.status?(e(o),$.ReportDirector.RefreshReportGeneralOfEmployeesDataSummary()):(e(l),alert("Ошибка: "+t.message))}var a=$(this).parent(),r=a.hasClass("decimal"),l=r?parseFloat($(this).attr("last-value")||0):parseInt($(this).attr("last-value")||0),o=r?parseFloat($(this).val()||0):parseInt($(this).val()||0);if(l!=o){var i=$("#general-year").data("DateTimePicker").date().year(),n=$("#general-month").val(),s={idSite:$("#generalSite").find("input:radio:checked").val(),idEmployee:$(this).closest("[id-employee]").attr("id-employee"),year:i,month:n,value:o};$.post(BaseUrl+"reports/lovestory/daily/plan/agency/save",s,t,"json")}else e(l)}),$(document).on("click","#overallAllocationSite input:radio",function(e){$.ReportDirector.ReloadReportOverallAllocation($(e.target).val())})},InitDynamicData:function(){},InitTemplate:function(){$("#reportGeneralOfEmployees_data_Template").template("reportGeneralOfEmployees_data_Template"),$("#reportGeneralOfEmployees_total_Template").template("reportGeneralOfEmployees_total_Template"),$("#reportOverallSalaryTemplate").template("reportOverallSalaryTemplate"),$("#reportGeneralSalarySumTemplate").template("reportGeneralSalarySumTemplate"),$("#reportOverallAllocation_Template").template("reportOverallAllocation_Template")},ReloadReportOverallSalary:function(e){function t(e){e.status?($.tmpl("reportOverallSalaryTemplate",e.records).appendTo(a),$.ReportDirector.RefreshReportOverallSalaryDataSummary()):alert("Ошибка получения данных")}e=e||$("#overlaySalarySite").find("input:radio:checked").val();var a=$("#ReportOverallSalary_data").find(">tbody");a.empty();var r={SiteID:e,year:$("#overlay-salary-year").data("DateTimePicker").date().year(),month:$("#overlay-salary-month").val()};$.post(BaseUrl+"reports/overlay/salary/data",r,t,"json")},RefreshReportOverallSalaryDataSummary:function(){var e=$("#ReportOverallSalary_data");$(e).find("tr").find("td:eq(9)").html(0),$(e).find("tbody>tr").each(function(){var e=parseFloat($(this).find("td:eq(2) div").html())||0,t=parseFloat($(this).find("td:eq(4) div").html())||0,a=parseFloat($(this).find("td:eq(6) div").html())||0,r=parseFloat($(this).find("td:eq(8) div").html())||0;$(this).find("td:eq(9)").html((e+t+a+r).toFixed(2))});var t=$(e).find("tfoot td:eq(9)");$(e).find("tbody>tr").find("td:eq(9)").each(function(){var e=parseFloat($(this).html())||0,a=parseFloat(t.html())||0;t.html((a+e).toFixed(2))})},ReloadReportGeneralSalary:function(){function e(e){e.status?($("#ReportGeneralSalary_data tbody tr[id-employee] td[id-site]").html("-"),$(e.cross).each(function(e,t){$('#ReportGeneralSalary_data tbody tr[id-employee="'+t.EmployeeID+'"] td[id-site="'+t.SiteID+'"]').html("")}),$(e.records).each(function(e,t){if(t.EmployeeID>0){var a='#ReportGeneralSalary_data tbody tr[id-employee="'+t.EmployeeID+'"] td[id-site="'+t.SiteID+'"]';$(a).attr("sum",t.value),1==t.paid&&$(a).closest("td").addClass("repay"),$.tmpl("reportGeneralSalarySumTemplate",t).appendTo(a)}else{var r='#ReportGeneralSalary_data thead tr[id-employee="'+t.EmployeeID+'"] td[id-site="'+t.SiteID+'"]';$(r).attr("sum",t.value),$(r).find("div").html(t.value);var l=$("#ReportGeneralSalary_data").find("thead th[data-total]");l.html(((parseFloat(l.html())||0)+parseFloat(t.value)).toFixed(2))}}),$.ReportDirector.ReloadReportGeneralSalaryDataSummary()):alert("Ошибка получения данных")}$("#ReportGeneralSalary_data").find("thead tr[id-employee] td[id-site] div").empty(),$("#ReportGeneralSalary_data").find("tbody tr[id-employee] td[id-site]").empty().removeClass("repay");var t={year:$("#general-salary-year").data("DateTimePicker").date().year(),month:$("#general-salary-month").val()};$.post(BaseUrl+"reports/general/salary/data",t,e,"json")},ReloadReportGeneralSalaryDataSummary:function(){$(".total-salary-report-table thead td[id-site]").each(function(){var e=$(this).attr("id-site"),t=parseFloat($(this).find("div").html())||0;$('.total-salary-report-table tbody td[id-site="'+e+'"]').each(function(){t-=parseFloat($(this).find("div>a").html())||0}),$('.total-salary-report-table tfoot td[id-site="'+e+'"]').html(t.toFixed(2))});var e=parseFloat($("#ReportGeneralSalary_data").find("thead th[data-total]").html())||0,t=$("#ReportGeneralSalary_data").find("tfoot td[data-total]");t.html(e.toFixed(2)),$(".total-salary-report-table tbody tr").each(function(){var e=$(this),a=0;$(this).find("td[id-site][sum]").each(function(){a+=parseFloat($(this).attr("sum"))}),e.find("td[data-total]").html(a.toFixed(2)),t.html(((parseFloat(t.html())||0)-a).toFixed(2))})},ReloadReportGeneralOfCustomers:function(){$.ReportDirector.ReloadGeneralOfCustomersMeta()},ReloadReportOverallAllocation:function(e){function t(e){e.status?($.tmpl("reportOverallAllocation_Template",e.records).appendTo(a),$("#ReportOverallNotAllocation_data").find("td").html(e.records.freeAllSitesCustomers)):alert("Ошибка получения данных")}e=e||$("#overallAllocationSite").find("input:radio:checked").val();var a=$("#ReportOverallAllocation_data").find(">tbody");a.empty(),$("#ReportOverallNotAllocation_data").find("td").empty(),$.post(BaseUrl+"reports/overall/allocation/data",{SiteID:e},t,"json")},ReloadGeneralOfEmployeesMeta:function(e){function t(){return r.data("DateTimePicker").date().year()}function a(e){if(e.status){var a=t(),r=l.val(),o=moment([a,r]).endOf("month").date();e.records.days=[];for(var i=1;i<=o;i++)e.records.days.push({day:i,date:moment([a,r,i]).format("YYYY-MM-DD")});$.tmpl("reportGeneralOfEmployees_data_Template",e.records).appendTo("#ReportGeneralOfEmployees_data"),$.tmpl("reportGeneralOfEmployees_total_Template",e.records).appendTo("#ReportGeneralOfEmployees_total"),$.ReportDirector.ReloadReportGeneralOfEmployeesData()}}$("#ReportGeneralOfEmployees_data").empty(),$("#ReportGeneralOfEmployees_total").empty();var r=$("#general-year"),l=$("#general-month"),o={site:e||$("#generalSite").find("input:radio:checked").val()};$.post(BaseUrl+"reports/lovestory/general/meta",o,a,"json")},ReloadReportGeneralOfEmployeesData:function(){function e(e){e.status&&($.each(e.records.plans,function(e,a){t.find('tr[id-employee="'+a.EmployeeID+'"] .plan').html(a.plan)}),$.each(e.records.report,function(e,a){t.find("#ger_"+a.EmployeeID+"_"+a.date).html((parseFloat(a.emails)+parseFloat(a.chat)).toFixed(2))}),t.find("tfoot tr:eq(1)>td>div").html(0),$.each(e.records.agent,function(){$("#apm_"+this.EmployeeID).find("div").html(this.value)}),$.ReportDirector.RefreshReportGeneralOfEmployeesDataSummary())}var t=$("#ReportGeneralOfEmployees_data");t.find(".plan, .emails, .chat").html(0);var a={year:$("#general-year").data("DateTimePicker").date().year(),month:$("#general-month").val(),site:$("#generalSite").find("input:radio:checked").val()};$.post(BaseUrl+"reports/lovestory/general/data",a,e,"json")},RefreshReportGeneralOfEmployeesDataSummary:function(){var e=$("#ReportGeneralOfEmployees_data");e.find("tfoot tr:eq(0)>td:gt(0)").html(0),$("#ReportGeneralOfEmployees_total").find("tbody td").html(0);var t=$("#rge_total_bal");t.html(0),$(e).find("tbody .value").each(function(){var e=$(this).closest("[id-employee]").attr("id-employee"),a=$("#rge_total_"+e);a.html((parseFloat(a.html())+parseFloat($(this).html())).toFixed(2));var r=$(this).attr("day"),l=$("#rge_sum_total_"+r);l.html((parseFloat(l.html())+parseFloat($(this).html())).toFixed2),t.html((parseFloat(t.html())+parseFloat($(this).html())).toFixed(2))});var a=$("#rge_plan_sum_total");$(e).find("tbody .plan").each(function(){var e=$(this).closest("[id-employee]").attr("id-employee"),t=$("#rge_plan_"+e),r=$("#rge_total_"+e);t.html((parseFloat($(this).html())-parseFloat(r.html())).toFixed(2)),a.html((parseFloat(a.html())+parseFloat($(this).html())).toFixed(2))});var r=$("#rge_agent_plan_sum_total");$(e).find("tbody .is-edit>div").each(function(){r.html((parseFloat(r.html())+parseFloat($(this).html())).toFixed(2))})}},$.ReportDirector.Init()});